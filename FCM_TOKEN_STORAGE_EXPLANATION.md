# FCM Token Storage - Frontend vs Backend

## ğŸ”„ How FCM Tokens Are Stored

### Frontend (App) Storage

**Where:** Local device memory (managed by Firebase SDK)

**What's Stored:**
- FCM token is generated by Firebase SDK on the device
- Token is stored in app's memory/state
- Token is NOT persisted in Realm or local database
- Token is regenerated when app restarts (if needed)

**Code Location:**
```typescript
// src/hooks/usePushNotification.ts
const [fcmToken, setFcmToken] = useState<string | null>(null);

// Token is stored in React state (memory only)
const token = await messaging().getToken();
setFcmToken(token); // Stored in component state
```

### Backend (Server) Storage

**Where:** Database (MongoDB/PostgreSQL/etc.)

**What's Stored:**
- FCM token sent from app
- Stored in User model/table
- Persisted permanently until deleted

**Database Schema:**
```javascript
// Backend User Model
{
  _id: "...",
  phone: "...",
  name: "...",
  fcm_token: "dKx8...", // â† Stored here
  fcm_token_updated_at: "2025-01-15T10:30:00Z"
}
```

## ğŸ“Š Complete Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         DEVICE (Frontend)                â”‚
â”‚                                          â”‚
â”‚  1. Firebase SDK generates token         â”‚
â”‚     messaging().getToken()               â”‚
â”‚                                          â”‚
â”‚  2. Token stored in React state          â”‚
â”‚     setFcmToken(token)                   â”‚
â”‚     (Memory only, not persisted)         â”‚
â”‚                                          â”‚
â”‚  3. Send token to backend                â”‚
â”‚     POST /api/user/fcm-token            â”‚
â”‚     { fcm_token: "dKx8..." }            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚
                   â”‚ HTTP Request
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         BACKEND (Server)                 â”‚
â”‚                                          â”‚
â”‚  4. Receive token from app               â”‚
â”‚     req.body.fcm_token                   â”‚
â”‚                                          â”‚
â”‚  5. Store in database                    â”‚
â”‚     User.fcm_token = token               â”‚
â”‚     (Permanently stored)                 â”‚
â”‚                                          â”‚
â”‚  6. Use token to send notifications      â”‚
â”‚     admin.messaging().send({             â”‚
â”‚       token: user.fcm_token              â”‚
â”‚     })                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ Key Points

### Frontend (App)
- âœ… Token is generated on device
- âœ… Token is stored in React state (memory)
- âœ… Token is sent to backend
- âŒ Token is NOT stored in Realm/local DB
- âŒ Token is NOT persisted across app restarts (Firebase handles this)

### Backend (Server)
- âœ… Token is received from app
- âœ… Token is stored in database (User table)
- âœ… Token is used to send notifications
- âœ… Token is updated when refreshed
- âœ… Token is deleted on logout

## ğŸ’¾ Storage Locations Summary

| Location | What's Stored | Purpose | Persistence |
|----------|--------------|---------|-------------|
| **Frontend State** | FCM token (current) | Display/use in app | Memory only |
| **Backend Database** | FCM token (all users) | Send notifications | Permanent |
| **Firebase SDK** | Token cache | Firebase internal | Managed by SDK |

## ğŸ” Why Both?

### Frontend Storage (State)
- Quick access in app
- Display token if needed
- Check if token exists

### Backend Storage (Database)
- **Send notifications** - Backend needs tokens to send
- **User management** - Track which users can receive
- **Persistence** - Token survives app uninstall/reinstall
- **Multi-device** - User can have multiple devices

## ğŸ“ Example: Complete Flow

### 1. User Logs In (Frontend)
```typescript
// App generates token
const token = await messaging().getToken();
// Token: "dKx8abc123..."

// Store in state
setFcmToken(token);

// Send to backend
await saveFCMToken(token, authToken);
// POST /api/user/fcm-token
// Body: { fcm_token: "dKx8abc123..." }
```

### 2. Backend Receives (Backend)
```javascript
// Backend receives token
const { fcm_token } = req.body;
// fcm_token: "dKx8abc123..."

// Store in database
await User.findByIdAndUpdate(userId, {
  fcm_token: "dKx8abc123...",
  fcm_token_updated_at: new Date(),
});
```

### 3. Backend Sends Notification (Backend)
```javascript
// Get user's token from database
const user = await User.findById(userId);
// user.fcm_token: "dKx8abc123..."

// Send notification using stored token
await admin.messaging().send({
  token: user.fcm_token, // â† From database
  notification: {
    title: "New News",
    body: "Check it out",
  },
});
```

## ğŸš¨ Important Notes

1. **Frontend token is temporary** - Stored in memory, not persisted
2. **Backend token is permanent** - Stored in database, used for sending
3. **Token can be different** - If user reinstalls app, new token is generated
4. **Backend must have token** - Can't send notifications without backend token
5. **Token refresh updates both** - New token sent to backend automatically

## âœ… Summary

**Frontend:**
- Generates token
- Stores in React state (memory)
- Sends to backend

**Backend:**
- Receives token
- Stores in database (permanent)
- Uses to send notifications

**Answer:** Yes, the token is stored in the frontend (React state), but it's **also sent to and stored in the backend database**. The backend uses the database tokens to send notifications to users.











